---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

<!-- devtools::build_readme() is a good way to build this -->

<a href="man/figures/aedes-coconut-hex.png"><img src="man/figures/aedes-coconut.png" align="right" height="200" alt="An Aedes aegypti mosquito sipping coconut milk on a starry purple background. See coconatfly and natverse links for the significance of this image." /></a>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# aedes

<!-- badges: start -->
[![docs](https://github.com/flyconnectome/aedes/actions/workflows/pkgdown.yaml/badge.svg)](https://github.com/flyconnectome/aedes/actions/workflows/pkgdown.yaml)
[![natverse](https://img.shields.io/badge/natverse-Part%20of%20the%20natverse-a241b6)](https://natverse.github.io)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/flyconnectome/aedes/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/flyconnectome/aedes/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The **aedes** package provides programmatic access to the in progress *Aedes aegypti* connectome dataset. It integrates with [coconatfly](https://natverse.org/coconatfly) and the wider [natverse](https://natverse.org/) ecosystem.
We recommend that you use the [coconatfly](https://natverse.org/coconatfly) package where possible in order to ensure a uniform experience across different insect connectome datasets and sophisticated out of the box analyses.

Note that this dataset is still in an early state of proofreading and annotation and access is currently in a limited pre-release testing phase as we develop a robust community and infrastructure.

## Implementation Details

The package is delivered as a thin wrapper around
[fafbseg](https://natverse.org/natverse/fafbseg) with optional registration for
[coconatfly](https://natverse.org/coconatfly). This will be familiar to users
of the [fancr](https://github.com/flyconnectome/fancr) and
[bancr](https://github.com/flyconnectome/bancr) packages.

As a CAVE package you must have access and an appropriate token recorded. 
Metadata for this project is stored in a seatable web-accessible database
accessed via `fafbseg::flytable_*` functions which are wrapped by this package.

CAVE datasets have a concept of the active `materialisation version` which 
defines the state of the segmentation used for analysis. Alternatively a 
`timestamp` can be specified to allow an exact point in time to be used. 

## Installation

The package must be installed from github:
```{r installation, eval=FALSE}
if (!requireNamespace("natmanager", quietly = TRUE)) {
  install.packages("natmanager")
}
natmanager::install(pkgs = "flyconnectome/aedes")
```

You also need to do some additional one time setup.

Access to the segmentation / connectivity information is via CAVE. 
We use the python CAVE client under the hood and this must be installed via
`simple_python()`. Authentication is via a token, which is typically shared across CAVE projects (e.g. flywire, FANC, BANC etc). You can make a new one linked to the email
address authorised to access web resources via neuroglancer.

In order to start using flytable, you must get an API token. There doesn't seem to be a convenient way to do this from the seatable web interface but you can get one by calling `flytable_set_token()` with your flytable user and password. This should be a once only step. Thereafter you should have a `FLYTABLE_TOKEN` environment variable set in your `.Renviron` file.
```{r, eval=FALSE}
# required 
fafbseg::simple_python()

# Will open browser to get new token
fafbseg::flywire_set_token()
# Writes a known token to correct location
fafbseg::flywire_set_token("2f88e16c4f21bfcb290b2a8288c05bd0")

fafbseg::flytable_set_token()
```


## Setup for coconatfly

We recommend using coconatfly for most analysis. At the moment you must tell
coconatfly about the aedes dataset once per R session.

```{r setup, message=FALSE}
library(aedes)
library(coconatfly)

# once per session
register_aedes_coconat()
```

## Examples

```{r examples, message=FALSE}
library(dplyr)

# 1) List neurons with class ALPN
alpn_meta <- cf_meta(cf_ids(aedes = "/class:ALPN"))
alpn_meta %>% count(subclass, subsubclass)
```

Select a smaller set of PN neurons with type matching G2X

```{r}
gpn_ids <- cf_meta(cf_ids(aedes = "/type:G2[0-9].*PN"))
gpn_meta <- cf_meta(gpn_ids)
gpn_meta %>% count(type, side) %>% tidyr::spread(side, n)
```

Now we can cluster by connectivity. This depends on partner neurons having
some kind of identity recorded, typically via the type column (the default) or
the numeric group column (which is often set even when a formal type has not 
been proposed). At the time of writing PN input partners (ORNs) are well typed
but downstream partners less so. So let's just use input partners and also 
restrict to neurons that have already been typed with n=2 neurons in the type 
so that we have a small plot.

```{r}
gpn_meta %>% 
  add_count(type) %>% 
  filter(n==2) %>% 
  cf_cosine_plot(partners = 'in')
```

There are a wealth of options for the clustering. You can select input partners
only or using the group column rather than type for defining the neuron-type 
connectivity matrix. You can turn off partner grouping (which can actually work
better in some circumstances when there is limited partner type information available) but you will not be able to co-cluster L and R homologues.

```{r, eval=FALSE}
cf_cosine_plot(gpn_ids, heatmap = T, partners = 'in')
cf_cosine_plot(gpn_ids, heatmap = T, partners = 'in', group = 'group')
cf_cosine_plot(gpn_ids, heatmap = T, partners = 'in', group = FALSE)
```

The default threshold setting of 5 synapse may be a little restrictive for 
this dataset where synapses counts seem to be low (even without considering 
proofreading).

```{r}
cf_cosine_plot(gpn_ids, heatmap = T, partners = 'in', group = FALSE, threshold = 2)
```


## Notes

- Access to the Aedes segmentation depends on your CAVE dataset permissions.
- Some functions require access to the FlyTable
